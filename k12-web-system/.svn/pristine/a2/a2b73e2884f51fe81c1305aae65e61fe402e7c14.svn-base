package com.wdcloud.jyx.web.system.controller;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.core.MediaType;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.core.env.Environment;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.sun.jersey.api.client.Client;
import com.wdcloud.boot.core.model.ResponseModel;
import com.wdcloud.boot.core.util.AppUtil;
import com.wdcloud.jyx.web.system.SystemConstants;
import com.wdcloud.jyx.web.system.model.UserInfoModel;
import com.wdcloud.jyx.web.system.util.CommonUtils;
import com.wdcloud.login.client.session.SessionUserHolder;

/**
 * 文件名称： com.wdcloud.jyx.web.system.controller.UserInfoAction.java</br>
 * 初始作者： wangpengju</br>
 * 创建日期： 2017年8月8日</br>
 * 功能说明： 教研员信息web接口类 <br/>
 * =================================================<br/>
 * 修改记录：<br/>
 * 修改作者 日期 修改内容<br/>
 * ================================================<br/>
 * Copyright (c) 2010-2011 .All rights reserved.<br/>
 */
@RestController
@RequestMapping("/web_jyy")
public class UserInfoAction {

	@Autowired
	SessionUserHolder		sessionUserHolder;
	@Autowired
	private Environment		env;
	@Autowired
	private AppUtil			appUtil;
	@Autowired
	private CodeAction		codeAction;
	private static Logger	log	= LoggerFactory.getLogger(UserInfoAction.class);

	/**
	 * 方法描述: 新增/修改教研员信息</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月8日-下午3:56:50<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/bcjyyxx", method = RequestMethod.POST)
	@ResponseBody
	public Object saveJyyxx(@RequestBody UserInfoModel userInfoModel, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();

		if (StringUtils.isNotBlank(userInfoModel.getOrgid()) && StringUtils.isNotBlank(userInfoModel.getSectioncode())
				&& StringUtils.isNotBlank(userInfoModel.getSubjectcode())
				&& StringUtils.isNotBlank(userInfoModel.getUsername())) {
			String loginid = sessionUserHolder.getLoginId(request);

			// TODO 测试账号
			// loginid = "2000245277";

			Map<String, Object> params_Map = new HashMap<String, Object>();
			Map<String, Object> params_jyy_Map = new HashMap<String, Object>();
			params_Map.put("id", userInfoModel.getOrgid());
			String jcxxserver_url = env.getProperty("wdcloud.jyx.jcxx.url");
			Map postForEntity = appUtil.postForEntity(
					jcxxserver_url + "/jcxx/selectorganizationbyid",
					params_Map, Map.class);
			if ("true".equals(postForEntity.get("isSuccess"))) {
				JSONObject jcbb = (JSONObject) postForEntity.get("rows");
				userInfoModel.setLocation(jcbb.getString("location"));
				userInfoModel.setLoginid(loginid);
				params_jyy_Map = CommonUtils.beantoMapFilterEmpty(userInfoModel);
				Map jyyEntity = appUtil.postForEntity(
						jcxxserver_url +
						"/jcxx/bcjyyxx",
						params_jyy_Map, Map.class);
				if ("true".equals(jyyEntity.get("isSuccess"))) {
					return jyyEntity;
				} else {
					responseModel.setIsSuccess("false");
					responseModel.setMsgCode("0003");
					return responseModel;
				}
			} else {
				responseModel.setIsSuccess("false");
				responseModel.setMsgCode("0002");
				return responseModel;
			}
		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0001");
			return responseModel;
		}

	}

	/**
	 * 方法描述: 跟据用户id来得到用户详情信息</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月8日-下午5:05:56<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @param userInfoModel
	 * @param request
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/cxjyyxx", method = RequestMethod.GET)
	@ResponseBody
	public Object searchJyyXxById(UserInfoModel userInfoModel, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();
		if (StringUtils.isNotBlank(userInfoModel.getUserinfo_id())) {
			Map<String, Object> params_Map = new HashMap<String, Object>();
			String jcxxserver_url = env.getProperty("wdcloud.jyx.jcxx.url");
			params_Map.put("userinfo_id", userInfoModel.getUserinfo_id());
			Map responseEntity = appUtil.postForEntity(
					jcxxserver_url +
					"/jcxx/cxjyyxx",
					params_Map, Map.class);
			if ("true".equals(responseEntity.get("isSuccess"))) {
				return responseEntity;
			} else {
				responseModel.setIsSuccess("false");
				responseModel.setMsgCode("0002");
				return responseModel;
			}

		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0001");
			return responseModel;
		}
	}

	/**
	 * 方法描述: 分页查询教研员信息列表</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月8日-下午5:23:11<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @param userInfoModel
	 * @param request
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/cxjyyxxlb", method = RequestMethod.GET)
	@ResponseBody
	public ResponseModel searchJyyxxlb(UserInfoModel userInfoModel, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();
		String language = LocaleContextHolder.getLocale().getLanguage();
		// 当前登录人账号
		String loginid = sessionUserHolder.getLoginId(request);

		// TODO 测试用
		// loginid = "2000244729";

		String jcxxserver_url = env.getProperty("wdcloud.jyx.jcxx.url");
		if (SystemConstants.SYSTEM_SFDM_1.equals(userInfoModel.getFlagType()) && userInfoModel.getRows() != null
				&& userInfoModel.getPage() != null
				|| SystemConstants.SYSTEM_SFDM_0.equals(userInfoModel.getFlagType())) {
			Map<String, Object> params_Map = new HashMap<String, Object>();

			if (StringUtils.isNotBlank(userInfoModel.getOrgid())) {
				params_Map.put("sfcorgid", "0");
				params_Map.put("orgid", userInfoModel.getOrgid());
			} else {
				params_Map.put("sfcorgid", "1");
				// 调server层根据当前登录人的账号查他的orgid
				Map<String, Object> orgMap = new HashMap<String, Object>();
				orgMap.put("loginid", loginid);
				Map responseOrg = appUtil.postForEntity(
						jcxxserver_url +
						"/jcxx/cxjyyOrgbyzh",
						orgMap, Map.class);
				if ("true".equals(responseOrg.get("isSuccess"))) {
					String orgid = (String) responseOrg.get("rows");
					params_Map.put("orgid", orgid);
				} else {
					responseModel.setIsSuccess("false");
					responseModel.setMsgCode("0003");
					return responseModel;
				}

			}
			params_Map.put("loginid", loginid);
			params_Map.put("flagType", userInfoModel.getFlagType());
			params_Map.put("rows", userInfoModel.getRows());
			params_Map.put("page", userInfoModel.getPage());
			params_Map.put("username", userInfoModel.getUsername() != null ? userInfoModel.getUsername() : "");
			params_Map.put("lrsj_start", userInfoModel.getLrsj_start() != null ? userInfoModel.getLrsj_start() : "");
			params_Map.put("lrsj_end", userInfoModel.getLrsj_end() != null ? userInfoModel.getLrsj_end() : "");
			params_Map.put("sfcjzh", userInfoModel.getSfcjzh() != null ? userInfoModel.getSfcjzh() : "");
			// params_Map.put("orgid", userInfoModel.getOrgid() != null ? userInfoModel.getOrgid() : "");
			ResponseModel responseEntity = appUtil.postForEntity(
					jcxxserver_url +
					"/jcxx/cxjyyxxlb",
					params_Map, ResponseModel.class);
			if ("true".equals(responseEntity.getIsSuccess())) {

				String url = env.getProperty("wdcloud.k12.syscode.url") + "/system/syscode/getcodeclass";
				Map<String, Object> xdMap = new HashMap<String, Object>();
				xdMap.put("codeClass", SystemConstants.CODECLASS_XDCDM);
				xdMap.put("language", language);
				LinkedHashMap<String, Map<String, Object>> xdCodes_map = appUtil.postForEntity(
						url, xdMap,
						LinkedHashMap.class);

				Map<String, Object> xkMap = new HashMap<String, Object>();
				xkMap.put("codeClass", SystemConstants.CODECLASS_ZXXKCDM);
				xkMap.put("language", language);
				LinkedHashMap<String, Map<String, Object>> xkCodes_map = appUtil.postForEntity(
						url, xkMap,
						LinkedHashMap.class);

				List<Map<String, Object>> responseRows = (List<Map<String, Object>>) responseEntity.getRows();
				if (responseRows != null && responseRows.size() > 0) {
					for (Map<String, Object> map : responseRows) {
						String sectioncode = (String) map.get("sectioncode");
						String subjectcode = (String) map.get("subjectcode");
						String xdkm = "";
						String[] xds = sectioncode.split(",");
						String[] xks = subjectcode.split(",");
						if (xds.length == xks.length) {
							for (int i = 0; i < xks.length; i++) {
								String xd = xds[i];
								String xk = xks[i];
								if (xdCodes_map.containsKey(xd) && xkCodes_map.containsKey(xk)) {
									String xddesc = (String) xdCodes_map.get(xd).get("codedesc");
									String xkdesc = (String) xkCodes_map.get(xk).get("codedesc");
									xdkm += xddesc + xkdesc + "、";
								}
							}
						}
						if (xdkm.length() > 0) {
							map.put("xdkm", xdkm.substring(0, xdkm.length() - 1));
						} else {
							map.put("xdkm", "");
						}
					}

				}

				return responseEntity;
			} else {
				responseModel.setIsSuccess("false");
				responseModel.setMsgCode("0002");
				responseModel.setRows(new ArrayList<Map<String, Object>>());
				responseModel.setRecords("0");
				return responseModel;
			}

		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0001");
			responseModel.setRows(new ArrayList<Map<String, Object>>());
			responseModel.setRecords("0");
			return responseModel;
		}

	}

	/**
	 * 方法描述: 创建账号</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月8日-下午5:57:22<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @param userInfoModel
	 * @param request
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/cjzh", method = RequestMethod.POST)
	@ResponseBody
	public Object createAccount(@RequestBody UserInfoModel userInfoModel, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();
		if (StringUtils.isNotBlank(userInfoModel.getPassword())) {
			Map<String, Object> params_Map = new HashMap<String, Object>();
			String jcxxserver_url = env.getProperty("wdcloud.jyx.jcxx.url");
			List<Map<String, String>> yxjyy = JSON.parseObject(userInfoModel.getYxjyy(), List.class);
			if (yxjyy != null && yxjyy.size() == 0) {
				UserInfoModel infoModel = new UserInfoModel();
				infoModel.setSfcjzh(SystemConstants.SYSTEM_SFDM_0);
				infoModel.setFlagType(SystemConstants.SYSTEM_SFDM_0);
				ResponseModel re = searchJyyxxlb(infoModel, request);
				if ("true".equals(re.getIsSuccess())) {
					List<Map<String, Object>> jyylb = (List<Map<String, Object>>) re.getRows();
					for (Map<String, Object> map : jyylb) {
						Map<String, String> jyyMap = new HashMap<String, String>();
						jyyMap.put("userinfo_id", (String) map.get("userinfo_id"));
						jyyMap.put("username", (String) map.get("username"));
						jyyMap.put("birthday", (String) map.get("birthday"));
						yxjyy.add(jyyMap);
					}
				}
			}

			params_Map.put("yxjyy", yxjyy);
			params_Map.put("password", userInfoModel.getPassword());
			Map responseEntity = appUtil.postForEntity(
					jcxxserver_url +
					"/jcxx/cjzh",
					params_Map, Map.class);
			if ("true".equals(responseEntity.get("isSuccess"))) {
				return responseEntity;
			} else {
				responseModel.setIsSuccess("false");
				responseModel.setMsgCode("0002");
				return responseModel;
			}
		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0001");
			return responseModel;
		}

	}

	/**
	 * 方法描述:查询组织机构树</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月8日-下午6:20:25<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @param userInfoModel
	 * @param request
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/cxzzjgs", method = RequestMethod.POST)
	@ResponseBody
	public Object selectOrgTree(String pid, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();

		String loginId = sessionUserHolder.getLoginId(request);

		// TODO 测试账号
		// loginId = "2000245277";

		Map<String, Object> params_Map = new HashMap<String, Object>();
		String jcxxserver_url = env.getProperty("wdcloud.jyx.jcxx.url");
		params_Map.put("orgid", pid);
		params_Map.put("loginId", loginId);
		Map responseEntity = appUtil.postForEntity(
				jcxxserver_url +
				"/jcxx/cxzzjgs",
				params_Map, Map.class);
		if ("true".equals(responseEntity.get("isSuccess"))) {
			return responseEntity;
		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0002");
			return responseModel;
		}

	}

	/**
	 * 方法描述: 删除教研员</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月8日-下午7:06:35<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/scjyy", method = RequestMethod.POST)
	@ResponseBody
	public Object deleteJyy(@RequestBody UserInfoModel userInfoModel, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();
		String loginid = sessionUserHolder.getLoginId(request);

		// TODO 测试账号
		// loginid = "2000245277";

		if (StringUtils.isNotBlank(userInfoModel.getUserinfo_id())) {
			Map<String, Object> params_Map = new HashMap<String, Object>();
			String jcxxserver_url = env.getProperty("wdcloud.jyx.jcxx.url");
			params_Map.put("loginid", loginid);
			params_Map.put("userinfo_id", userInfoModel.getUserinfo_id());
			Map responseEntity = appUtil.postForEntity(
					jcxxserver_url +
					"/jcxx/scjyy",
					params_Map, Map.class);
			if ("true".equals(responseEntity.get("isSuccess"))) {
				return responseEntity;
			} else {
				responseModel.setIsSuccess("false");
				responseModel.setMsgCode("0002");
				return responseModel;
			}
		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0001");
			return responseModel;
		}

	}

	/**
	 * 方法描述: 重置密码</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月9日-上午10:01:00<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @param userInfoModel
	 * @param request
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/czmm", method = RequestMethod.POST)
	@ResponseBody
	public Object resetPassword(@RequestBody UserInfoModel userInfoModel, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();
		if (StringUtils.isNotBlank(userInfoModel.getAccount())
				&& StringUtils.isNotBlank(userInfoModel.getNew_password())) {
			String account = userInfoModel.getAccount();
			String accountArr[] = account.split(",");
			Client client = Client.create();
			String serverUrl = env.getProperty("wdcloud.jyx.uic.server.url");
			boolean boo = true;
			for (String element : accountArr) {
				Map<String, Object> rcMap = new HashMap<String, Object>();
				Map<String, Object> rs = new HashMap<String, Object>();
				rcMap.put("loginid", element);
				rcMap.put("newpassword", userInfoModel.getNew_password());
				rcMap.put("passwordstrengthcheck", SystemConstants.SYSTEM_SFDM_0);

				rs = client.resource(serverUrl + "/rest/v1/users/password/updateByLoginID")
						.type(MediaType.APPLICATION_JSON)
						.post(Map.class, rcMap);
				if (!"1".equals(rs.get("result"))) {
					boo = false;
				}
			}
			if (boo) {
				responseModel.setIsSuccess("true");
				responseModel.setMsgCode("");
				return responseModel;
			} else {
				responseModel.setIsSuccess("false");
				responseModel.setMsgCode("0002");
				return responseModel;
			}
		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0001");
			return responseModel;
		}

	}

	/**
	 * 方法描述: 根据学段查学科</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月10日-上午11:11:54<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @param userInfoModel
	 * @param request
	 * @return
	 *         Object
	 */
	@RequestMapping(value = "/gjxdhdxk", method = RequestMethod.GET)
	@ResponseBody
	public Object searchXkByXd(UserInfoModel userInfoModel, HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();
		if (StringUtils.isNotBlank(userInfoModel.getXd())) {

			Map<String, Object> params_Map = new HashMap<String, Object>();

			params_Map.put("xd", userInfoModel.getXd());
			String jcxxserver_url = env.getProperty("wdcloud.jyx.jcxx.url");
			Map postForEntity = appUtil.postForEntity(
					jcxxserver_url +
					"/jcxx/cxkcbxd",
					params_Map, Map.class);
			if ("true".equals(postForEntity.get("isSuccess"))) {
				return postForEntity;
			} else {
				responseModel.setIsSuccess("false");
				responseModel.setMsgCode("0002");
				return responseModel;
			}
		} else {
			responseModel.setIsSuccess("false");
			responseModel.setMsgCode("0001");
			return responseModel;
		}
	}

	/**
	 * 方法描述: 校验用户是否登录</br>
	 * 初始作者: 王鹏举 <br/>
	 * 创建日期: 2017年8月23日-上午10:44:33<br/>
	 * 开始版本: 2.0.0<br/>
	 * =================================================<br/>
	 * 修改记录：<br/>
	 * 修改作者 王鹏举 日期 修改内容<br/>
	 * ================================================<br/>
	 *
	 * @param request
	 * @return
	 *         boolean
	 */
	@RequestMapping(value = "/ifLogin", method = RequestMethod.GET)
	@ResponseBody
	public ResponseModel checkIsLogin(HttpServletRequest request) {

		ResponseModel responseModel = new ResponseModel();
		Boolean isLogin = sessionUserHolder.isLogined(request);
		if (isLogin) {
			responseModel.setIsSuccess("true");
		} else {
			responseModel.setIsSuccess("false");
		}
		return responseModel;
	}
}
